<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Авенко - Подписка</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--tg-theme-bg-color, #ffffff);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        
        #tilda-iframe {
            width: 100%;
            height: 100vh;
            border: none;
            overflow: hidden;
        }
        
        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--tg-theme-bg-color, #ffffff);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--tg-theme-hint-color, #999999);
            border-top: 3px solid var(--tg-theme-button-color, #007AFF);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 16px;
            color: var(--tg-theme-text-color, #000000);
            font-size: 14px;
        }
        
        /* Hide scrollbars in iframe */
        iframe {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer/Edge */
        }
        
        iframe::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Загрузка...</div>
        </div>
    </div>
    
    <iframe 
        id="tilda-iframe" 
        src="" 
        allow="payment; camera; microphone; geolocation"
        referrerpolicy="strict-origin-when-cross-origin"
        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox">
    </iframe>

    <script>
        // Initialize Telegram WebApp
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        
        // Set theme colors
        document.documentElement.style.setProperty('--tg-theme-bg-color', window.Telegram.WebApp.themeParams.bg_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-text-color', window.Telegram.WebApp.themeParams.text_color || '#000000');
        document.documentElement.style.setProperty('--tg-theme-button-color', window.Telegram.WebApp.themeParams.button_color || '#007AFF');
        document.documentElement.style.setProperty('--tg-theme-hint-color', window.Telegram.WebApp.themeParams.hint_color || '#999999');
        
        // Get Tilda URL from URL parameters or use default
        const urlParams = new URLSearchParams(window.location.search);
        const tildaUrl = urlParams.get('url') || 'https://www.xn--80aafma3abvkxse9a7f.xn--p1ai/telegram_payment';
        
        // Function to inject CSS into iframe to hide footer
        function injectFooterRemovalCSS() {
            const iframe = document.getElementById('tilda-iframe');
            
            if (iframe && iframe.contentDocument) {
                try {
                    const style = iframe.contentDocument.createElement('style');
                    style.textContent = `
                        /* Hide Tilda footer completely */
                        .t-records .t-rec[data-record-type="215"] { 
                            display: none !important; 
                        }
                        
                        /* Hide common footer classes */
                        .t-footer,
                        footer,
                        .t-rec_pt_footer,
                        .t-sociallinks,
                        [class*="footer"],
                        [id*="footer"],
                        .t-cover__filter,
                        .t396__filter {
                            display: none !important;
                        }
                        
                        /* Remove bottom margin/padding from content */
                        body {
                            margin-bottom: 0 !important;
                            padding-bottom: 0 !important;
                        }
                        
                        /* Hide "Made on Tilda" branding */
                        .t030__copyright,
                        .t030__made-on-tilda,
                        .t-footer__copyright,
                        [class*="copyright"] {
                            display: none !important;
                        }
                        
                        /* Prevent link clicks in footer area */
                        .t-footer a,
                        footer a,
                        .t-sociallinks a {
                            pointer-events: none !important;
                            cursor: default !important;
                        }
                        
                        /* Ensure content fills the space */
                        .t-records {
                            padding-bottom: 20px !important;
                        }
                        
                        /* Hide any potential Tilda branding or links */
                        a[href*="tilda.cc"],
                        a[href*="tilda.com"],
                        .t-tildalink {
                            display: none !important;
                        }
                    `;
                    
                    iframe.contentDocument.head.appendChild(style);
                    console.log('Footer removal CSS injected successfully');
                } catch (error) {
                    console.log('Could not inject CSS due to CORS restrictions:', error);
                }
            }
        }
        
        // Function to handle iframe load
        function handleIframeLoad() {
            const loadingOverlay = document.getElementById('loading-overlay');
            
            // Hide loading overlay
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 300);
            
            // Try to inject CSS after a short delay
            setTimeout(injectFooterRemovalCSS, 1000);
            setTimeout(injectFooterRemovalCSS, 3000); // Try again after 3 seconds
        }
        
        // Function to intercept and handle link clicks
        function interceptLinks() {
            const iframe = document.getElementById('tilda-iframe');
            
            if (iframe && iframe.contentDocument) {
                try {
                    // Add click event listener to iframe document
                    iframe.contentDocument.addEventListener('click', function(event) {
                        const target = event.target.closest('a');
                        
                        if (target && target.href) {
                            // Check if it's an external link (not payment related)
                            const href = target.href.toLowerCase();
                            
                            // Allow payment-related links to work normally
                            if (href.includes('tinkoff') || 
                                href.includes('t-bank') || 
                                href.includes('securepay') ||
                                href.includes('payment') ||
                                href.includes('pay') ||
                                target.classList.contains('t-btn') ||
                                target.closest('.t-form')) {
                                return; // Allow these links to work
                            }
                            
                            // Block other external links
                            if (href.includes('tilda') || 
                                href.includes('http') ||
                                target.closest('.t-footer') ||
                                target.closest('footer')) {
                                event.preventDefault();
                                event.stopPropagation();
                                console.log('Blocked external link:', href);
                                
                                // Show notification that link was blocked
                                window.Telegram.WebApp.showAlert('Ссылка заблокирована для безопасности');
                                return false;
                            }
                        }
                    }, true);
                } catch (error) {
                    console.log('Could not intercept links due to CORS restrictions:', error);
                }
            }
        }
        
        // Set up iframe
        const iframe = document.getElementById('tilda-iframe');
        iframe.src = tildaUrl;
        
        // Handle iframe load
        iframe.onload = function() {
            handleIframeLoad();
            
            // Try to intercept links
            setTimeout(interceptLinks, 500);
            setTimeout(interceptLinks, 2000);
        };
        
        // Handle iframe errors
        iframe.onerror = function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.querySelector('.loading-text').textContent = 'Ошибка загрузки';
        };
        
        // Listen for messages from the iframe (if Tilda sends any)
        window.addEventListener('message', function(event) {
            // Handle payment completion or other messages from Tilda
            if (event.data && event.data.type === 'payment_success') {
                // Payment completed, send data to your bot
                window.Telegram.WebApp.sendData(JSON.stringify({
                    action: 'payment_completed',
                    transaction_id: event.data.transaction_id || null,
                    user_id: window.Telegram.WebApp.initDataUnsafe.user?.id || null
                }));
                
                // Close the WebApp
                window.Telegram.WebApp.close();
            }
        });
        
        // Handle back button
        window.Telegram.WebApp.BackButton.onClick(function() {
            window.Telegram.WebApp.close();
        });
        
        // Show back button
        window.Telegram.WebApp.BackButton.show();
        
        // Log for debugging
        console.log('Telegram WebApp initialized');
        console.log('Loading Tilda URL:', tildaUrl);
    </script>
</body>
</html>
